#!/usr/bin/env bash

HOME_DIR=$HOME
cd $HOME_DIR

INSTALLED=$(
    /usr/local/share/plexmediaserver/Plex_Media_Server --version \
    | sed 's/v//'
    )
VERSION=$(
    w3m -dump https://plex.tv/downloads/details/1\?build\=freebsd-x86_64\&channel\=16\&distro\=freebsd \
    | awk -F"\"" '/Release id/ {print $4}'
    )
ARCH="FreeBSD-amd64"
PLEX_TMP="PlexMediaServer-${VERSION}"
PLEX_DIR="plexmediaserver"
PLEX_DIR_OLD="plexmediaserver_old"
PLEX_PATH="/usr/local/share"
_SUDO="doas"

if [ $USER == "root" ];	then 
	echo "Avoid running this script as root"
	echo "Exiting ..."
else

status plexmediaserver >/dev/null 2>&1
PROCESS=$?

if [ "$INSTALLED" == "$VERSION" ]
	then
		echo "Running version : $INSTALLED"
		echo "Latest release  : $VERSION"
		echo " ________________________"
		echo "|                        |"
		echo "| No news is good news ! |"
		echo "|________________________|"
	#	echo "--------------------------"
		echo ""
	else
		echo "Running version : $INSTALLED"
		echo "Latest release  : $VERSION"
	echo "Update available, proceed ? (Y/n)"
	read ANSWER

	case ${ANSWER} in 
	n)
		exit 0
		;;

	*)
		echo "Download ..."
		ARCHIVE="PlexMediaServer-${VERSION}-${ARCH}.tar.bz2"
		wget https://downloads.plex.tv/plex-media-server-new/${VERSION}/freebsd/PlexMediaServer-${VERSION}-${ARCH}.tar.bz2
		echo "----"
	
		echo "Decompress ..."
		tar -xvf ${ARCHIVE} > /dev/null 2>&1
		mv ${PLEX_TMP} ${PLEX_DIR}
		rm PlexMediaServer-${VERSION}-${ARCH}.tar.bz2
		echo "----"

	if [ "${PROCESS}" -ne "0" ] ; then	
		echo "service stop ..."
		$_SUDO service plexmediaserver stop
		echo "----"
	fi
		echo "update in progress ..."
		cd ${PLEX_DIR}
		ln -s "Plex Media Server" Plex_Media_Server
		;;
	esac

	cd ${PLEX_PATH}
	if [ -d ${PLEX_DIR_OLD} ]
		then 
			$_SUDO rm -rf ${PLEX_DIR_OLD} # Remove previous old dir
			$_SUDO mv ${PLEX_DIR} ${PLEX_DIR_OLD} # Move current dir to old dir
			$_SUDO mv ${HOME_DIR}/${PLEX_DIR} ${PLEX_PATH}/ # Move new dir to plex path
			echo "----"
			echo "service start ..."
			$_SUDO service plexmediaserver start
		else
			$_SUDO mv ${PLEX_DIR} ${PLEX_DIR_OLD}
			$_SUDO mv ${HOME_DIR}/${PLEX_DIR} ${PLEX_PATH}/
			echo "service start ..."
			$_SUDO service plexmediaserver start
		fi
	fi
fi
